<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>地球Online v0.5.0</title>

    <style>
        *{ box-sizing:border-box }
        html,body{ height:100% }
        body{
            margin:0; background:#000; color:#fff;
            font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
            overflow:hidden;
        }
        #game-root{ position:relative; width:100vw; height:100vh; }

        .login-layer{ position:absolute; inset:0; z-index:10; overflow:hidden; }
        .stars{
            position:absolute; inset:0;
            background: radial-gradient(#fff 1px, transparent 1px);
            background-size: 6px 6px; opacity:.35;
        }

        .earth-wrap {
            position: absolute;
            left: 50%;
            top: 38%;
            transform: translate(-50%, -50%) rotateZ(-23.5deg);
            width: min(320px, 45vw);
            height: min(320px, 45vw);
            filter: drop-shadow(0 30px 80px rgba(0,0,0,0.5));
            perspective: 1000px;
        }

        .earth {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;

            background: url('assets/images/earth-map.jpg') repeat-x;
            background-size: cover;

            animation: earth-spin 20s linear infinite;

            box-shadow:
                    inset 0 0 25px rgba(0,0,0,0.7),
                    0 0 40px rgba(0,150,255,0.8),
                    0 0 80px rgba(0,100,200,0.4);
        }

        @keyframes earth-spin {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: -100% 0;
            }
        }

        .earth::after {
            /* 光影效果，增加立體感 */
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 40%),
            radial-gradient(circle at 70% 70%, rgba(0,0,0,0.7), transparent 55%);
            pointer-events: none;
        }

        /* 登入 UI */
        .login-ui{
            position:absolute; left:50%; top:72%; transform:translate(-50%,-50%);
            width:min(560px,92vw); text-align:center;
            background: rgba(0,0,0,.55);
            border:1px solid rgba(255,255,255,.25);
            border-radius:16px;
            padding:16px 18px;
            backdrop-filter: blur(8px);
        }
        #login-choices{ display:grid; gap:8px; grid-template-columns:1fr 1fr; }
        #login-choices button{
            all:unset; cursor:pointer; text-align:center;
            padding:10px 12px;
            background:rgba(255,255,255,.12);
            border:1px solid rgba(255,255,255,.28);
            border-radius:10px;
            transition:.15s;
        }
        #login-choices button:hover{
            background:rgba(255,255,255,.25);
            transform: translateY(-2px);
        }

        /* ===== 遊戲背景 ===== */
        .bg{
            position:absolute; inset:0; z-index:0;
            display:none;
            background-size:cover;
            background-position:center;
        }

        /* ===== 角色（只有淡入） ===== */
        .character{
            position:absolute; bottom:96px;
            width:min(26vw,360px); height:min(70vh,640px);
            display:none; align-items:flex-end;
            opacity:0; z-index:3;
        }
        .character.active{
            display:flex;
            animation: fadeIn 0.6s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .side-left{ left:2% }
        .side-right{ right:2% }
        .character .avatar{
            width:100%; height:100%;
            background-size:contain;
            background-repeat:no-repeat;
            background-position: bottom center;
            background-color: rgba(255,255,255,0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        .character .name{
            position:absolute; bottom:0; left:10px;
            background:rgba(0,0,0,.55);
            border:1px solid rgba(255,255,255,.25);
            padding:4px 8px;
            border-radius:8px;
            font-size:14px;
        }

        /* ===== 對話框 ===== */
        .dialog{
            position:absolute; left:50%; transform:translateX(-50%);
            bottom:20px;
            width:min(900px,76vw);
            background:rgba(0,0,0,.6);
            border:1px solid rgba(255,255,255,.22);
            border-radius:14px;
            padding:12px 16px;
            z-index:4;
            display:none;
        }
        .scene-title{ font-weight:800; color:#ffd166; margin-bottom:6px }
        .dialog-text{ font-size:16px; line-height:1.6; min-height:44px; }

        /* ===== 選項 ===== */
        .choices{
            position:absolute; left:50%; transform:translateX(-50%);
            bottom:130px;
            display:none;
            flex-direction:column;
            gap:18px;
            z-index:5;
            align-items:center;
        }
        .choice-btn {
            all: unset;
            cursor: pointer;
            width: min(420px, 90vw);
            text-align: center;

            /* 深色背景 */
            background: rgba(20, 20, 20, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.4);

            padding: 12px 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            transition: 0.2s;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            background: rgba(40, 40, 40, 0.95);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* ===== 小遊戲卡片 ===== */
        .mini-game{ position:absolute; inset:0; z-index:6; display:grid; place-items:center; }
        .mini-card{
            width:min(680px,92vw);
            background:rgba(0,0,0,.72);
            border:1px solid rgba(255,255,255,.22);
            border-radius:14px;
            padding:16px;
            backdrop-filter: blur(6px);
        }
        .mini-title{ font-size:20px; font-weight:800; margin-bottom:8px }
        .mini-question{ font-size:22px; margin:8px 0 14px }
        .mini-options{ display:grid; gap:10px }
        .mini-btn{
            all:unset; cursor:pointer; text-align:left;
            background:rgba(255,255,255,.14);
            border:1px solid rgba(255,255,255,.32);
            padding:10px 12px;
            border-radius:10px;
            transition:.15s;
        }
        .mini-btn:hover{ background:rgba(255,255,255,.28) }
        .mini-progress{ margin-top:10px; opacity:.85; font-size:14px }
    </style>
</head>
<body>
<div id="game-root">
    <!-- 登入層 -->
    <div class="login-layer" id="login-layer">
        <div class="stars"></div>
        <div class="earth-wrap">
            <div class="earth"></div>
        </div>
        <div class="login-ui" id="login-ui">
            <h1>🌏 地球 Online</h1>
            <p>亞洲黑色幽默增強版 v0.0.2</p>
            <div id="login-choices"></div>
        </div>
    </div>

    <!-- 背景 -->
    <div id="bg" class="bg"></div>

    <!-- 角色 -->
    <div id="char-left" class="character side-left">
        <div class="avatar"></div>
        <div class="name"></div>
    </div>
    <div id="char-right" class="character side-right">
        <div class="avatar"></div>
        <div class="name"></div>
    </div>

    <!-- 對話框 -->
    <div id="dialog" class="dialog">
        <div id="scene-title" class="scene-title"></div>
        <div id="dialog-text" class="dialog-text"></div>
    </div>

    <!-- 選項 -->
    <div id="choices" class="choices"></div>
</div>
<audio id="bgm-player" preload="auto" loop></audio>

<script>
    // Assets (using placeholders since files may not exist)
    const assets = {
        bg: {
            morning:  "assets/backgrounds/morning.jpg",
            train:    "assets/backgrounds/train.jpg",
            exam:     "assets/backgrounds/exam.jpg",
            lunch:    "assets/backgrounds/lunch.jpg",
            english:  "assets/backgrounds/english.jpg",
            home:     "assets/backgrounds/home.jpg",
            dinner:   "assets/backgrounds/dinner.jpg",
            final:    "assets/backgrounds/final.jpg",
            death:    "assets/backgrounds/death.jpg",
            ending:   "assets/backgrounds/ending.jpg",
        },
        chars: {
            player:  "assets/characters/player.png",
            mom:     "assets/characters/mom.png",
            dad:     "assets/characters/dad.png",
            teacher: "assets/characters/teacher.png",
        },
    };

    // Game scenes
    const scenes = {
        login: {
            title: "登入伺服器",
            text: "歡迎來到《地球Online》v0.0.2 亞洲黑色幽默增強版\n請選擇伺服器：",
            bg: null,
            left: null,
            right: null,
            choices: [
                { text: "亞洲（熱門，內卷修羅場）", next: "role" },
                { text: "美洲（須排隊800小時，美式快樂教育測試服）", death: "【失敗】伺服器排隊中，人生已過完一輪。" },
                { text: "歐洲（已爆滿，系統掛機養老模式）", death: "【失敗】伺服器滿員，請轉生至亞洲伺服器。" },
                { text: "非洲（尚未開放，資源不足伺服器）", death: "【失敗】伺服器不存在，夢想也不存在。" },
            ]
        },
        role: {
            title: "角色創建",
            text: "選擇角色：",
            bg: null,
            left: null, right: null,
            choices: [
                { text: "男性（自帶「打工人」天賦）", next: "intro" },
                { text: "女性（80% 被丟進河裡，20% 客服）", death: "【失敗】你還沒出生就被送去客服上班。" },
                { text: "購物袋（測試中，存活率未知）", death: "【失敗】一陣風起，你被吹走了。" },
            ]
        },
        intro: {
            title: "主角資訊",
            text: "名稱：郭益閎\n性別：男\n等級：15\n主線任務：讓父母開心，並設法活下來（亞洲服限定挑戰模式）",
            bg: "morning",
            left: "player",
            right: null,
            choices: [{text: "開始遊戲", next: "morning1"}]
        },
        /* ======= 早晨三段 ======= */
        morning1: {
            title: "早晨起床",
            bgm: "super_idol.mp3",
            text: "🎵 你被《Super Idol》的音樂吵醒，眼睛還沒睜開就感覺到母親的殺氣。",
            bg: "morning", left: "mom", right: "player",
            choices: [
                { text: "A. 醒來關鬧鐘", next: "morning2" },
                { text: "B. 繼續睡", death: "你錯過段考，被母親「閃電衣架劈」+ 父親「皮帶大法好」處決。\n🪦【別人起床拼未來，你起床拼喪禮】" }
            ]
        },

        morning2: {
            title: "刷牙時間",
            text: "浴室裡的牙刷靜靜地立著，你腦海中浮現一句古老的亞洲格言：「不刷牙，死更快」。",
            bg: "morning", left: null, right: "player",
            choices: [
                { text: "A. 認命刷牙", next: "morning3" },
                { text: "B. 偷玩手機", death: "滑倒撞破頭，手機成最後陪葬品。\n🪦【科技是進步，也是絆腳石】" }
            ]
        },

        morning3: {
            title: "早餐時間",
            text: "媽媽：「益閎，快吃早餐，不吃會死！」",
            bg: "morning", left: "mom", right: "player",
            choices: [
                { text: "A. 坐著吃早餐", next: "train1" },
                { text: "B. 邊走邊吃", death: "被貨車當早餐補鐵。\n🪦【別人補充營養，你補充鐵塊】" }
            ]
        },

        train1:{
            title: "上車找位子",
            text: "火車緩緩駛進月台，你擠進車廂時看到一個空位。",
            bg: "train", left: null, right: "player",
            choices: [
                { text: "A. 乖乖站著看書", next: "train2" },
                { text: "B. 搶博愛座", death: "被阿姨聯合攻擊，扔下車外。\n🪦【老天鵝啊，博愛博愛成悲哀】" }
            ]
        },

        train2: {
            title: "小偷事件",
            text: "突然有人大喊：「我的錢包不見了！」\n全車目光齊刷刷盯向你。",
            bg: "train", left: null, right: "player",
            choices: [
                { text: "A. 幫忙抓小偷", next: "train3" },
                { text: "B. 什麼都不做", death: "你被誤認為小偷，直接被群毆致死。\n🪦【沉默不代表無辜】" }
            ]
        },

        train3: {
            title: "選擇專注",
            text: "小偷事件落幕，火車繼續前進，你決定：",
            bg: "train", left: null, right: "player",
            choices: [
                { text: "A. 複習數學，準備迎接今天的考試", next: "exam1" },
                { text: "B. 玩手遊", death: "睡到高雄，下車發現段考結束，媽見打。\n🪦【高雄歡迎你，但你已無人生】" }
            ]
        },

        exam1: {
            title: "數學考試開始",
            text: "考卷一翻開，全是 sin、cos、tan 之類的東西，你發現自己複習錯範圍。",
            bg: "exam", left: "teacher", right: "player",
            choices: [
                { text: "A. 深呼吸冷靜下來", next: "exam2" },
                { text: "B. 放聲大哭", death: "監考老師認為你作弊，用圓規刺死你。\n🪦【眼淚換不來分數】" }
            ]
        },

        exam2:{
            title: "決定策略",
            text: "你環顧四周，同學們像一群機器人，瘋狂書寫。\n你只能：",
            bg: "exam", left: "teacher", right: "player",
            choices: [
                { text: "A. 祈禱神蹟", death: "佛祖保佑也救不了，回家鍋子伺候。\n🪦【神不救亞洲孩子】" },
                { text: "B. 尋找會做的題目", next: "MathGame" },
                { text: "C. 直接睡覺", death: "0 分，老爹施展「踹你死功夫」。\n🪦【睡眠是自由，代價是生命】" }
            ]
        },




        lunch1:{
            title: "午餐時段",
            text: "下課鐘響起，全班人衝向餐廳搶位子，你面臨選擇：",
            bg: "lunch", left: null, right: "player",
            choices: [
                { text: "A. 跟同學衝第一波", next: "lunch2" },
                { text: "B. 慢慢走，保持優雅", death: "你被後排暴衝的人群踩成肉餅。\n🪦【優雅是慢性自殺】" }
            ]
        },

        lunch2:{
            title: "餐廳修羅場",
            text: "終於拿到餐盤，前方出現三個攤位：炸雞排、青菜、神秘料理。",
            bg: "lunch", left: null, right: "player",
            choices: [
                { text: "A. 選炸雞排", next: "lunch3" },
                { text: "B. 選青菜", death: "被嘲笑太健康，被集體霸凌致死。\n🪦【綠色蔬菜，紅色血跡】" },
                { text: "C. 選神秘料理", death: "吃下去獲得 +99 腹瀉 DEBUFF，廁所猝死。\n🪦【探險是勇氣，也是殞命】" }
            ]
        },

        lunch3:{
            title: "午餐後",
            text: "吃飽後，你猶豫下一步該做什麼。",
            bg: "lunch", left: null, right: "player",
            choices: [
                { text: "A. 休息滑手機", death: "亞洲社會不允許你喘息。\n🪦【休息等於死亡】" },
                { text: "B. 背英文單字", next: "englishExam1" }
            ]
        },


        englishExam1:{
            title: "英文考試前夕",
            text: "老師走進教室，手裡拿著一疊厚厚的考卷，表情像在宣布死刑。",
            bg: "english", left: "teacher", right: "player",
            choices: [
                { text: "A. 深呼吸冷靜下來", next: "englishExam2" },
                { text: "B. 跟隔壁同學聊天", death: "被老師當場抓包，扣 100 分。\n🪦【社交是墳場】" }
            ]
        },

        englishExam2:{
            title: "第一題",
            text: "考卷第一題是一個超簡單的英文填空，\n如果錯了將遭到老師死亡凝視。",
            bg: "english", left: "teacher", right: "player",
            choices: [
                { text: "A. 認真作答", next: "englishExam3" },
                { text: "B. 隨便亂寫", death: "老師直接拿粉筆插進你氣管。\n🪦【亂寫速死】" }
            ]
        },

        englishExam3:{
            title: "考卷終章",
            text: "老師：「接下來是小遊戲環節，錯一題就 Game Over。」",
            bg: "english", left: "teacher", right: "player",
            choices: [
                { text: "開始英文小遊戲", next: "englishGame" }
            ]
        },


        home1:{
            title: "回到家",
            text: "你一踏進家門，就看到媽媽在廚房拿菜刀。",
            bg: "home", left: "mom", right: "player",
            choices: [
                { text: "A. 假裝沒看見，走回房間", next: "home2" },
                { text: "B. 調侃她：「Okaasan，cosplay 好像哦！」", death: "刀直接飛向你。\n🪦【玩笑也是死亡陷阱】" }
            ]
        },

        home2:{
            title: "父母質問",
            text: "媽媽：「你今天考得怎樣？」\n你：……",
            bg: "home", left: "mom", right: "dad",
            choices: [
                { text: "A. 誠實說考不好", death: "爸媽同時大爆炸，家庭核平。\n🪦【真相是引爆器】" },
                { text: "B. 撒謊說考很好", next: "home3" }
            ]
        },

        home3:{
            title: "關鍵選擇",
            text: "爸爸盯著你，眼神像要把你看穿。",
            bg: "home", left: "dad", right: "player",
            choices: [
                { text: "A. 裝晴天娃娃 → 隱藏通關", next: "hiddenEnding" },
                { text: "B. 低頭沉默", next: "dinner1" },
                { text: "C. 反擊頂嘴", death: "全家爆打你一頓，送急診未醒來。\n🪦【自由的代價是全滅】" }
            ]
        },


        dinner1:{
            title: "晚餐開局",
            text: "媽媽：「益閎，吃飯了！」\n桌上擺著滿滿菜餚。",
            bg: "dinner", left: "mom", right: "dad",
            choices: [
                { text: "A. 只吃白飯", next: "dinner2" },
                { text: "B. 完全不理她", death: "媽媽直接摔鍋砸頭。\n🪦【不吃即死，吃了更死】" }
            ]
        },

        dinner2:{
            title: "媽媽嘆氣",
            text: "媽媽嘆氣：「我煮這麼多，你不想吃就直說嘛！」",
            bg: "dinner", left: "mom", right: "player",
            choices: [
                { text: "A. 認慫，乖乖吃菜", next: "dinner3" },
                { text: "B. 嘴臭回懟", death: "爸媽合力開大。\n🪦【嘴臭換來家庭連坐】" }
            ]
        },

        dinner3:{
            title: "晚餐結束",
            text: "飯後，你覺得氣氛有些微妙，該做什麼呢？",
            bg: "dinner", left: "player", right: null,
            choices: [
                { text: "A. 幫忙收桌子", next: "finalEvent1" },
                { text: "B. 偷偷溜回房間", death: "被爸媽攔下當場斬立決。\n🪦【逃不出晚餐，也逃不出原生家庭】" }
            ]
        },


        dinner2: {
            title: "媽媽嘆氣",
            text: "媽媽嘆氣：「我煮這麼多，你不想吃就直說嘛！」",
            bg: "dinner", left: "mom", right: "player",
            choices: [
                { text: "A. 「你煮的像車諾比輻射三十年螢光料理。」", death: "媽見打 + 爸參戰。\n🪦【嘴臭換來家庭連坐】" },
                { text: "B. 「我們生活，我們愛，我們說謊，在亞特蘭提斯…」", death: "被認定嘉豪症候群，送走火化。\n🪦【中二是病，社會來醫】" },
                { text: "C. 認慫，乖乖吃菜。", next: "finalEvent1" }
            ]
        },

        finalEvent1:{
            title: "飯後選擇 1",
            text: "今晚的夜色讓你感到不安。",
            bg: "final", left: "player", right: null,
            choices: [
                { text: "A. 出去散步", next: "finalEvent2" },
                { text: "B. 直接睡覺", next: "ending" }
            ]
        },

        finalEvent2:{
            title: "散步途中",
            text: "走在巷子裡，一台貨車突然出現！",
            bg: "final", left: null, right: "player",
            choices: [
                { text: "A. 閃避貨車", next: "finalEvent3" },
                { text: "B. 呆站原地", death: "被貨車來回輾壓。\n🪦【飲料漲價只是序曲，貨車才是主旋律】" }
            ]
        },

        finalEvent3:{
            title: "終極選擇",
            text: "你安然走到便利商店前，想起今晚的煩惱：",
            bg: "final", left: "player", right: null,
            choices: [
                { text: "A. 買飲料", death: "一轉身被小混混刺死。\n🪦【甜蜜的飲料，血腥的代價】" },
                { text: "B. 回房讀書", death: "熬夜猝死。\n🪦【知識改變命運，但先改變你的壽命】" },
                { text: "C. 來場猜拳小遊戲", next: "rpsGame" },
                { text: "D. 回家安然睡覺", next: "ending" }
            ]
        },


        hiddenEnding: {
            title: "隱藏通關",
            text: "✨ 成功裝成晴天娃娃 = 通關，但只是進入「新手村地獄副本」。",
            bg: "ending", left: null, right: null,
            choices: [ { text: "重新投胎（回登入）", next: "login" } ]
        },

        ending: {
            title: "遊戲結算",
            text: () => `📊 存活時間：18 小時 32 分鐘\n死亡次數：${state.deaths}\nBuff：內卷 MAX、比較心態 +999、亞洲式陰影 永久綁定\n\n⚠️ 《地球Online》亞洲伺服器為永久 Hard 模式，無法調整難度。\nDLC：補習班煉獄篇（必買）／相親安排篇（中國服）／養老醫院排隊篇（歐洲測試中）`,
            bg: "ending", left: null, right: null,
            choices: [ { text: "重新投胎（回登入）", next: "login", action: () => { state.deaths = 0; } } ]
        },

        death: {
            title: "你死了",
            text: "……",
            bg: "death", left: null, right: null,
            choices: [ { text: "回到登入畫面", next: "login", action: () => { state.deaths = 0; } } ]
        }
    };

    /* 遊戲狀態 */
    let state = {
        scene: "login",
        deaths: 0
    };

    /* ===== 工具函數 ===== */
    function rand(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffle(arr) {
        return arr.sort(() => Math.random() - 0.5);
    }

    /* 打字機效果 */
    let typerTimer = null;
    function typeWriter(el, text, speed = 34) {
        if (typerTimer) clearInterval(typerTimer);
        el.textContent = "";
        let i = 0;
        typerTimer = setInterval(() => {
            el.textContent += text.charAt(i++);
            if (i >= text.length) clearInterval(typerTimer);
        }, speed);
    }

    /* 重置畫面，避免重疊 */
    function resetUI() {
        document.getElementById("choices").innerHTML = "";
        document.getElementById("choices").style.display = "none";
        document.getElementById("dialog-text").textContent = "";
        ["char-left", "char-right"].forEach(id => {
            const c = document.getElementById(id);
            c.classList.remove("active");
            c.style.display = "none";
        });
        // 移除小遊戲層
        document.querySelectorAll(".mini-game").forEach(el => el.remove());
    }

    /* ===== 初始化登入選單 ===== */
    (function initLoginButtons() {
        const box = document.getElementById("login-choices");
        box.innerHTML = "";
        scenes.login.choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.textContent = choice.text;
            btn.onclick = () => handleChoice(choice);
            box.appendChild(btn);
        });
    })();

    /* ===== 背景管理 ===== */
    function setBackground(key) {
        const el = document.getElementById("bg");
        if (!key) {
            el.style.backgroundImage = "none";
            return;
        }
        const url = assets.bg[key];
        if (!url) {
            el.style.backgroundImage = "none";
            return;
        }
        // 若圖片載入失敗，使用漸層背景避免空白
        const img = new Image();
        img.onload = () => (el.style.backgroundImage = `url('${url}')`);
        img.onerror = () => (el.style.backgroundImage = "radial-gradient(1000px 800px at 50% 120%, #202020, #000)");
        img.src = url;
    }

    /* ===== 角色顯示（淡入） ===== */
    function renderChar(id, who) {
        const wrap = document.getElementById(id);
        if (!who) {
            wrap.style.display = "none";
            wrap.classList.remove("active");
            return;
        }
        const emoji = assets.chars[who];
        const avatar = wrap.querySelector(".avatar");
        const name = wrap.querySelector(".name");

        const nameMap = {
            player: "郭益閎",
            mom: "媽媽",
            dad: "爸爸",
            teacher: "老師"
        };

        name.textContent = nameMap[who] || who;
        if (emoji) {
            avatar.style.backgroundImage = `url('${emoji}')`;
            avatar.textContent = "";
        } else {
            avatar.style.backgroundImage = "none";
            avatar.textContent = "👤";
        }

        wrap.style.display = "flex";
        wrap.classList.remove("active");
        void wrap.offsetWidth; // 強制重繪，確保動畫觸發
        wrap.classList.add("active");
    }

    /* ===== 處理選項 ===== */
    function handleChoice(choice) {
        // 死亡分支
        if (choice.death) {
            state.deaths++;
            scenes.death.text = choice.death;
            state.scene = "death";
            resetUI();
            renderScene();
            return;
        }

        // 特殊動作
        if (choice.action) choice.action();

        // 進入數學小遊戲
        if (choice.next === "MathGame") {
            resetUI();
            startMathGame();
            return;
        }
        // 進入英文小遊戲
        if (choice.next === "englishGame") {
            resetUI();
            startEnglishGame();
            return;
        }
        // 進入猜拳小遊戲
        if (choice.next === "rpsGame") {
            resetUI();
            startRpsGame();
            return;
        }

        // 切換場景
        if (choice.next) {
            state.scene = choice.next;
            resetUI();
            renderScene();
        }
    }

    /* ===== 渲染場景 ===== */
    function renderScene() {
        const s = scenes[state.scene];

        // 登入畫面顯示
        if (state.scene === "login") {
            document.getElementById("login-layer").style.display = "block";
            document.getElementById("bg").style.display = "none";
            document.getElementById("dialog").style.display = "none";
            return;
        } else {
            document.getElementById("login-layer").style.display = "none";
            document.getElementById("bg").style.display = "block";
            document.getElementById("dialog").style.display = "block";
        }

        // 設定背景與角色
        setBackground(s.bg);
        renderChar("char-left", s.left);
        renderChar("char-right", s.right);

        // 場景標題與文字
        document.getElementById("scene-title").textContent = s.title || "";
        const textEl = document.getElementById("dialog-text");
        const fullText = typeof s.text === "function" ? s.text() : (s.text || "");
        typeWriter(textEl, fullText, 30);

        // 選項
        const box = document.getElementById("choices");
        box.innerHTML = "";
        s.choices.forEach(c => {
            const b = document.createElement("button");
            b.className = "choice-btn";
            b.textContent = c.text;
            b.onclick = () => handleChoice(c);
            box.appendChild(b);
        });
        box.style.display = "flex";
    }

    /* ========== 小遊戲：實數與簡單代數混合題 ========== */

    /* 啟動數學遊戲 */
    /* ========== 小遊戲：實數與簡單代數混合題 ========== */

    /* 啟動數學遊戲 */
    function startMathGame() {
        const root = document.getElementById("game-root");
        const layer = document.createElement("div");
        layer.className = "mini-game";
        layer.innerHTML = `
    <div class="mini-card">
      <div class="mini-title">✨ 保命題（20 題全對才過）</div>
      <div class="mini-question" id="mq"></div>
      <div class="mini-options" id="mo"></div>
      <div class="mini-progress" id="mp"></div>
    </div>`;
        root.appendChild(layer);

        let correct = 0;
        renderQ();

        /** 渲染題目 */
        function renderQ() {
            const { q, ans, options } = genAlgebraQ();
            document.getElementById("mq").textContent = q;
            const mo = document.getElementById("mo");
            mo.innerHTML = "";

            options.forEach((opt, i) => {
                const b = document.createElement("button");
                b.className = "mini-btn";
                b.textContent = `${"ABCD"[i]}. ${opt}`;
                b.onclick = () => {
                    if (opt === ans) {
                        correct++;
                        if (correct >= 20) {
                            root.removeChild(layer);
                            state.scene = "lunch1"; // 完成後回到劇情
                            resetUI();
                            renderScene();
                            return;
                        }
                        document.getElementById("mp").textContent = `正確！還差 ${20 - correct} 題`;
                        renderQ();
                    } else {
                        root.removeChild(layer);
                        state.deaths++;
                        scenes.death.text = "亞服特色：錯一題 = 回家躺平。🪦【算錯一題，人生 Game Over】";
                        state.scene = "death";
                        resetUI();
                        renderScene();
                    }
                };
                mo.appendChild(b);
            });
            document.getElementById("mp").textContent = `目前連對：${correct} / 20`;
        }
    }

    /* ===== 題型隨機選擇 ===== */
    function genAlgebraQ() {
        const types = ["arithmetic", "sqrt", "algebra1", "algebra2", "sqrtXY"];
        const pick = types[rand(0, types.length - 1)];

        if (pick === "arithmetic") {
            return genRealQ(); // 四則運算
        } else if (pick === "sqrt") {
            return genSqrtQ(); // 單純根號題
        } else if (pick === "algebra1") {
            return genSolveForX(); // 單變數
        } else if (pick === "algebra2") {
            return genSolveForXY(); // 普通雙變數
        } else {
            return genSqrtXYQ(); // **根號+二元一次混合題**
        }
    }

    /* ===== 1. 基本實數題 ===== */
    function genRealQ() {
        const ops = ["+", "-", "×", "÷"];
        const op = ops[rand(0, ops.length - 1)];

        let a = rand(2, 20);
        let b = rand(2, 20);
        let ans = 0;

        if (op === "+") {
            ans = a + b;
        } else if (op === "-") {
            if (b > a) [a, b] = [b, a];
            ans = a - b;
        } else if (op === "×") {
            ans = a * b;
        } else if (op === "÷") {
            // 保證整除
            b = rand(2, 9);
            ans = rand(2, 12);
            a = ans * b;
        }

        const q = `${a} ${op} ${b} = ?`;

        // 干擾選項
        const wrongOptions = [];
        while (wrongOptions.length < 3) {
            let w = ans + rand(-3, 3);
            if (w !== ans && w >= 0 && !wrongOptions.includes(w)) {
                wrongOptions.push(w);
            }
        }

        const options = shuffle([ans, ...wrongOptions]).slice(0, 4);
        return { q, ans, options };
    }

    /* ===== 2. 單變數方程題 ===== */
    function genSolveForX() {
        // 隨機生成：ax + b = c
        const a = rand(1, 9);
        const x = rand(1, 12);
        const b = rand(0, 10);
        const c = a * x + b;

        const q = `${a}x + ${b} = ${c}，求 x`;

        const wrongOptions = [];
        while (wrongOptions.length < 3) {
            let w = x + rand(-3, 3);
            if (w !== x && w >= -10 && !wrongOptions.includes(w)) {
                wrongOptions.push(w);
            }
        }

        const options = shuffle([x, ...wrongOptions]);
        return { q, ans: x, options };
    }

    /* ===== 3. 兩變數簡單代入 ===== */
    function genSolveForXY() {
        // 先隨機出 x 和 y 的真值
        const x = rand(1, 9);
        const y = rand(1, 9);

        // 題目形式：c1 x + c2 y
        const c1 = rand(1, 5);
        const c2 = rand(1, 5);
        const result = c1 * x + c2 * y;

        const q = `若 x=${x} 且 y=${y}，求 ${c1}x + ${c2}y`;

        const wrongOptions = [];
        while (wrongOptions.length < 3) {
            let w = result + rand(-5, 5);
            if (w !== result && !wrongOptions.includes(w) && w >= 0) {
                wrongOptions.push(w);
            }
        }

        const options = shuffle([result, ...wrongOptions]);
        return { q, ans: result, options };
    }

    /* ===== 4. 根號 + 二元一次混合題 ===== */
    function genSqrtXYQ() {
        // 先確定 x, y 的值
        const x = rand(1, 6);
        const y = rand(1, 6);

        // 生成一個完全平方數，確保 sqrt 是整數
        const perfectSquares = [4, 9, 16, 25, 36, 49, 64, 81, 100];
        const sqrtPart = perfectSquares[rand(0, perfectSquares.length - 1)];

        // 生成兩個係數
        const c1 = rand(1, 4);
        const c2 = rand(1, 4);

        // 正確答案
        const result = Math.sqrt(sqrtPart) + (c1 * x) + (c2 * y);

        // 題目文字
        const q = `若 x=${x} 且 y=${y}，求 √${sqrtPart} + ${c1}x + ${c2}y`;

        // 干擾選項
        const wrongOptions = [];
        while (wrongOptions.length < 3) {
            let w = result + rand(-5, 5);
            if (w !== result && w >= 0 && !wrongOptions.includes(w)) {
                wrongOptions.push(w);
            }
        }

        const options = shuffle([result, ...wrongOptions]).slice(0, 4);
        return { q, ans: result, options };
    }


    /* ========== 小遊戲：英文填空 ========== */
    function startEnglishGame() {
        const root = document.getElementById("game-root");
        const layer = document.createElement("div");
        layer.className = "mini-game";
        layer.innerHTML = `
    <div class="mini-card">
      <div class="mini-title">📝 英文填空（錯一題 Game Over）</div>
      <div class="mini-question" id="eq"></div>
      <div class="mini-options" id="eo"></div>
      <div class="mini-progress" id="ep"></div>
    </div>`;
        root.appendChild(layer);

        const qs = [
            { q: "Never gonna ____ you up", a: "give", options: ["give", "take", "love", "play"] },
            { q: "Super idol 的笑容 都沒你的 ____", a: "甜", options: ["甜", "鹹", "酸", "苦"] },
            { q: "Join the Hell ____", a: "divers", options: ["divers", "drivers", "lovers", "diners"] },
            { q: "I wanna be the very ____", a: "best", options: ["best", "worst", "famous", "richest"] },
            { q: "Oppa Gangnam ____", a: "Style", options: ["Style", "Smile", "Song", "Dance"] },
            { q: "Happy ever ____", a: "after", options: ["after", "long", "here", "ending"] }
        ];

        let i = 0;
        render();

        function render() {
            const cur = qs[i];
            document.getElementById("eq").textContent = cur.q;
            const eo = document.getElementById("eo");
            eo.innerHTML = "";

            cur.options.forEach(opt => {
                const b = document.createElement("button");
                b.className = "mini-btn";
                b.textContent = opt;
                b.onclick = () => {
                    if (opt === cur.a) {
                        i++;
                        if (i >= qs.length) {
                            root.removeChild(layer);
                            state.scene = "home1";
                            resetUI();
                            renderScene();
                            return;
                        }
                        render();
                    } else {
                        root.removeChild(layer);
                        state.deaths++;
                        scenes.death.text = "🪦【英語沒背好，社會提前爆破】";
                        state.scene = "death";
                        resetUI();
                        renderScene();
                    }
                };
                eo.appendChild(b);
            });
            document.getElementById("ep").textContent = `第 ${i + 1} / ${qs.length} 題`;
        }
    }

    /* ========== 小遊戲：猜拳 ========== */
    function startRpsGame() {
        const root = document.getElementById("game-root");
        const layer = document.createElement("div");
        layer.className = "mini-game";
        layer.innerHTML = `
    <div class="mini-card">
      <div class="mini-title">✊✋✌️ 猜拳遊戲（贏兩次才算過，輸一次 Game Over）</div>
      <div class="mini-question" id="rps-result">選擇你的出拳：</div>
      <div class="mini-options" id="rps-options"></div>
      <div class="mini-progress" id="rps-progress"></div>
    </div>`;
        root.appendChild(layer);

        const rpsOptions = ["剪刀", "石頭", "布"];
        let wins = 0;
        const optsEl = document.getElementById("rps-options");
        optsEl.innerHTML = "";
        rpsOptions.forEach(opt => {
            const b = document.createElement("button");
            b.className = "mini-btn";
            b.textContent = opt;
            b.onclick = () => play(opt);
            optsEl.appendChild(b);
        });
        document.getElementById("rps-progress").textContent = "需贏 2 次才能通過";

        function play(userChoice) {
            const cpuChoice = rpsOptions[rand(0, 2)];
            const resultEl = document.getElementById("rps-result");
            const progressEl = document.getElementById("rps-progress");
            const winMap = { "剪刀": "布", "布": "石頭", "石頭": "剪刀" };
            if (userChoice === cpuChoice) {
                resultEl.textContent = `平手！你出 ${userChoice}，對方出 ${cpuChoice}`;
                progressEl.textContent = `已贏 ${wins} 次，需贏 2 次`;
                return;
            }
            if (winMap[userChoice] === cpuChoice) {
                wins++;
                resultEl.textContent = `你贏了！你出 ${userChoice}，對方出 ${cpuChoice}`;
                if (wins >= 2) {
                    root.removeChild(layer);
                    state.scene = "ending";
                    resetUI();
                    renderScene();
                    return;
                }
                progressEl.textContent = `已贏 ${wins} 次，需贏 2 次`;
            } else {
                resultEl.textContent = `你輸了！你出 ${userChoice}，對方出 ${cpuChoice}`;
                root.removeChild(layer);
                state.deaths++;
                scenes.death.text = "猜拳失敗，真是手殘。🪦【玩不起猜拳，人生也玩不起】";
                state.scene = "death";
                resetUI();
                renderScene();
            }
        }
    }

    renderScene();
</script>
</body>
</html>